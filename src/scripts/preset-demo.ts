#!/usr/bin/env node

import { runForm, runFormWithPresets, saveFormAsPreset } from '../forms'
import {
  createPresetLoadForm,
  createPresetManagementForm,
  createSavePresetPromptForm,
  defaultPresetManager,
} from '../forms'
import { FormBuilder, QuestionHelpers, ValidationHelpers } from '../forms/helpers'

// Create a sample form to demonstrate presets
const sampleForm = new FormBuilder('sample-app', 'üöÄ Sample App Generator')
  .description('Create your sample application with presets!')
  .settings({
    allowBack: true,
    showProgress: true,
    submitLabel: 'Generate App',
    cancelLabel: 'Cancel',
  })

  .group('project-info', 'Project Information')
  .question(
    QuestionHelpers.text('projectName', 'Project Name', {
      required: true,
      defaultValue: 'my-sample-app',
      validation: [
        ValidationHelpers.required(),
        ValidationHelpers.pattern(
          /^[a-zA-Z0-9-_]+$/,
          'Project name can only contain letters, numbers, hyphens, and underscores',
        ),
      ],
    }),
  )
  .question(
    QuestionHelpers.text('description', 'Project Description', {
      placeholder: 'A sample application',
    }),
  )

  .group('features', 'Features')
  .question(
    QuestionHelpers.multiselect(
      'selectedFeatures',
      'Which features would you like?',
      [
        { label: 'TypeScript', value: 'typescript' },
        { label: 'React', value: 'react' },
        { label: 'Node.js API', value: 'api' },
        { label: 'Database (PostgreSQL)', value: 'database' },
        { label: 'Authentication', value: 'auth' },
        { label: 'GraphQL', value: 'graphql' },
      ],
      {
        required: true,
        defaultValue: ['typescript'],
      },
    ),
  )

  .group('deployment', 'Deployment Options')
  .question(
    QuestionHelpers.select(
      'deploymentTarget',
      'Deployment Target',
      [
        { label: 'Docker', value: 'docker' },
        { label: 'Vercel', value: 'vercel' },
        { label: 'Heroku', value: 'heroku' },
        { label: 'AWS', value: 'aws' },
        { label: 'None', value: 'none' },
      ],
      {
        defaultValue: 'docker',
      },
    ),
  )

  .build()

async function runPresetDemo() {
  console.log(`
üéØ Preset System Demo
====================

This demo shows how to use the preset system to save and reuse form configurations.

Features demonstrated:
‚Ä¢ Loading existing presets
‚Ä¢ Saving form answers as presets
‚Ä¢ Managing presets
‚Ä¢ Preset metadata and organization

Let's get started!
`)

  const { demo } = await runForm({
    id: 'preset-demo-choice',
    title: 'Preset Demo Selection',
    groups: [
      {
        id: 'choice',
        questions: [
          {
            id: 'demo',
            type: 'select',
            title: 'What would you like to do?',
            required: true,
            options: [
              {
                label: 'üÜï Create and Save a Preset',
                value: 'create',
                description: 'Fill out the form and save as a preset',
              },
              {
                label: 'üìÇ Load and Use a Preset',
                value: 'load',
                description: 'Use an existing preset (requires saved presets)',
              },
              {
                label: '‚öôÔ∏è Manage Presets',
                value: 'manage',
                description: 'View, delete, or export presets',
              },
              {
                label: 'üéÆ Full Demo',
                value: 'full',
                description: 'Complete workflow: create, save, load presets',
              },
            ],
          },
        ],
      },
    ],
  })

  switch (demo) {
    case 'create':
      await demoCreatePreset()
      break
    case 'load':
      await demoLoadPreset()
      break
    case 'manage':
      await demoManagePresets()
      break
    case 'full':
      await demoFullWorkflow()
      break
  }
}

async function demoCreatePreset() {
  console.log(`\nüìù Create and Save Preset Demo\n`)

  try {
    // Run the form normally
    const answers = await runForm(sampleForm, {
      validateOnChange: true,
    })

    console.log('\n‚úÖ Form completed! Here are your answers:')
    console.log(JSON.stringify(answers, null, 2))

    // Ask if they want to save as preset
    const savePrompt = createSavePresetPromptForm()
    const saveChoice = await runForm(savePrompt, { validateOnChange: true })

    if (saveChoice.shouldSave) {
      // Get preset details
      const { savePresetForm } = await import('../forms/definitions')
      const presetDetails = await runForm(savePresetForm, { validateOnChange: true })

      // Save the preset
      const success = await saveFormAsPreset(
        sampleForm.id,
        answers,
        presetDetails.presetName,
        presetDetails.presetDescription,
        presetDetails.presetTags
          ?.split(',')
          .map((tag: string) => tag.trim())
          .filter(Boolean),
      )

      if (success) {
        console.log(`\nüíæ Preset saved successfully as: "${presetDetails.presetName}"`)

        // Show preset count
        const presets = await defaultPresetManager.getPresetsForForm(sampleForm.id)
        console.log(`üìä You now have ${presets.length} preset(s) for this form`)
      } else {
        console.log('\n‚ùå Failed to save preset')
      }
    } else {
      console.log('\n‚è≠Ô∏è  Skipped saving preset')
    }
  } catch (error) {
    console.log('\n‚ùå Demo was cancelled or failed')
  }
}

async function demoLoadPreset() {
  console.log(`\nüìÇ Load Preset Demo\n`)

  try {
    // Check if any presets exist
    const presets = await defaultPresetManager.getPresetsForForm(sampleForm.id)

    if (presets.length === 0) {
      console.log('‚ùå No presets found for this form. Please create and save a preset first.')
      return
    }

    console.log(`üìä Found ${presets.length} preset(s) for this form:`)
    presets.forEach((preset, index) => {
      console.log(`   ${index + 1}. ${preset.name}${preset.description ? ` - ${preset.description}` : ''}`)
    })

    // Use the preset-enabled form runner
    const result = await runFormWithPresets(sampleForm, {
      validateOnChange: true,
    })

    console.log('\n‚úÖ Form completed!')

    if (result.usedPreset) {
      const preset = await defaultPresetManager.getPreset(result.usedPreset)
      console.log(`üìÇ Loaded from preset: "${preset?.name}"`)
    } else {
      console.log('üÜï Started fresh (no preset loaded)')
    }

    console.log('\nüìã Final answers:')
    console.log(JSON.stringify(result.answers, null, 2))
  } catch (error) {
    console.log('\n‚ùå Demo was cancelled or failed')
  }
}

async function demoManagePresets() {
  console.log(`\n‚öôÔ∏è Preset Management Demo\n`)

  try {
    // Show current presets
    const allPresets = await defaultPresetManager.getAllPresets()
    const formPresets = await defaultPresetManager.getPresetsForForm(sampleForm.id)

    console.log(`üìä Storage Info:`)
    const storageInfo = defaultPresetManager.getStorageInfo()
    console.log(`   ‚Ä¢ Total presets: ${storageInfo.count}`)
    console.log(`   ‚Ä¢ Storage size: ${storageInfo.estimatedSize}`)
    console.log(`   ‚Ä¢ Presets for this form: ${formPresets.length}`)

    if (allPresets.length === 0) {
      console.log('\n‚ùå No presets found. Create some presets first!')
      return
    }

    console.log('\nüìã All presets:')
    allPresets.forEach((preset, index) => {
      const date = new Date(preset.createdAt).toLocaleDateString()
      console.log(`   ${index + 1}. ${preset.name} (${preset.formId}) - ${date}`)
      if (preset.description) {
        console.log(`      Description: ${preset.description}`)
      }
      if (preset.tags && preset.tags.length > 0) {
        console.log(`      Tags: ${preset.tags.join(', ')}`)
      }
    })

    // Run management form
    const managementForm = await createPresetManagementForm()
    const action = await runForm(managementForm, { validateOnChange: true })

    if (action.action === 'view' && action.selectedPreset) {
      const preset = await defaultPresetManager.getPreset(action.selectedPreset)
      if (preset) {
        console.log(`\nüìã Preset Details: "${preset.name}"`)
        console.log(`   ‚Ä¢ Form: ${preset.formId}`)
        console.log(`   ‚Ä¢ Created: ${new Date(preset.createdAt).toLocaleString()}`)
        console.log(`   ‚Ä¢ Updated: ${new Date(preset.updatedAt).toLocaleString()}`)
        console.log(`   ‚Ä¢ Answer count: ${Object.keys(preset.answers).length}`)
        if (preset.description) {
          console.log(`   ‚Ä¢ Description: ${preset.description}`)
        }
        if (preset.tags) {
          console.log(`   ‚Ä¢ Tags: ${preset.tags.join(', ')}`)
        }
        console.log('\nüìä Answers:')
        console.log(JSON.stringify(preset.answers, null, 2))
      }
    } else if (action.action === 'delete' && action.selectedPreset && action.confirmDelete) {
      const success = await defaultPresetManager.deletePreset(action.selectedPreset)
      if (success) {
        console.log('\n‚úÖ Preset deleted successfully')
      } else {
        console.log('\n‚ùå Failed to delete preset')
      }
    } else if (action.action === 'export') {
      const exportData = await defaultPresetManager.exportPresets()
      console.log('\nüì§ Export Data:')
      console.log(exportData)
      console.log('\nüí° You can save this to a file and import it later')
    } else if (action.action === 'clear' && action.confirmClear === 'DELETE ALL') {
      await defaultPresetManager.clearAllPresets()
      console.log('\n‚úÖ All presets cleared')
    }
  } catch (error) {
    console.log('\n‚ùå Management demo was cancelled or failed')
  }
}

async function demoFullWorkflow() {
  console.log(`\nüéÆ Full Preset Workflow Demo\n`)

  try {
    console.log('Step 1: Create your first preset...')
    await demoCreatePreset()

    console.log('\n' + '='.repeat(50))
    console.log('Step 2: Load and modify the preset...')
    await demoLoadPreset()

    console.log('\n' + '='.repeat(50))
    console.log('Step 3: Manage your presets...')
    await demoManagePresets()

    console.log('\nüéâ Full workflow demo completed!')
  } catch (error) {
    console.log('\n‚ùå Full workflow demo was cancelled or failed')
  }
}

async function main() {
  try {
    await runPresetDemo()

    console.log(`
üåü Preset Demo Complete!

The preset system provides powerful capabilities for saving and reusing form configurations:

‚ú® Key Features Demonstrated:
   ‚Ä¢ Save form answers as reusable presets
   ‚Ä¢ Load presets to prefill forms
   ‚Ä¢ Organize presets with names, descriptions, and tags
   ‚Ä¢ Manage presets (view, delete, export)
   ‚Ä¢ Automatic storage in localStorage
   ‚Ä¢ Form-specific preset filtering

üí° Integration Tips:
   ‚Ä¢ Use \`runFormWithPresets()\` for automatic preset loading
   ‚Ä¢ Use \`saveFormAsPreset()\` for easy preset saving
   ‚Ä¢ Use \`PresetManager\` for advanced preset operations
   ‚Ä¢ Presets work with any form using the form system

üöÄ This system can significantly improve user experience by allowing them
   to save and reuse common configurations across multiple runs!
`)
  } catch (error) {
    console.error('üí• Demo failed:', error)
    process.exit(1)
  }
}

main().catch(error => {
  console.error('üí• Unexpected error:', error)
  process.exit(1)
})

export { runPresetDemo, demoCreatePreset, demoLoadPreset, demoManagePresets, demoFullWorkflow }
